import { Module, OnModuleInit } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';
import { DbConfigSchema } from 'src/models/db-config';
import { ProductItem } from 'src/models/product-item';
import { ProductsModule } from '../products/products.module';
import { ProductsService } from '../products/products.service';
import { DbConfigService } from './db-config.service';

@Module({
	imports: [MongooseModule.forFeature([{ name: 'DbConfig', schema: DbConfigSchema }]), ProductsModule],
	controllers: [],
	providers: [DbConfigService],
})
export class DbConfigModule implements OnModuleInit {
	constructor(
		private readonly dbConfigService: DbConfigService,
		private readonly productsService: ProductsService
	) { }

	async onModuleInit() {
		const dbConfig = await this.dbConfigService.findDbConfig();

		if (!dbConfig || !dbConfig.is_seeded) {
			const mobilePhonesCategory = await this.productsService.insertProductCategory({ title: 'Mobile phones', description: '(IOS and Android)' })
			const laptopsCategory = await this.productsService.insertProductCategory({ title: 'Laptops', description: 'New and used ones' })

			const products: Partial<ProductItem>[] = [
				{
					title: 'Apple iphone 11 red',
					description: 'The iPhone 11 display has rounded corners that follow a beautiful curved design, and these corners are within a standard rectangle. When measured as a standard rectangular shape, the screen is 6.06 inches diagonally (actual viewable area is less)',
					price: 699,
					availableCount: 12,
					productCategory: mobilePhonesCategory
				},
				{
					title: 'Apple iphone 12 blue',
					description: 'The iPhone 11 display has rounded corners that follow a beautiful curved design, and these corners are within a standard rectangle. When measured as a standard rectangular shape, the screen is 6.06 inches diagonally (actual viewable area is less)',
					price: 750,
					availableCount: 5,
					productCategory: mobilePhonesCategory
				},
				{
					title: 'HP Victus',
					description: '15-fa0032dx Gaming Laptop - 12th Intel Core i7-12650H 10-Cores, 16GB RAM, 512GB SSD, NVIDIA RTX3050Ti 4GB GDDR6 Graphics, 15.6 inch FHD (1920x1080) IPS 144Hz, Backlit KB, Windows 11- Mica Silver',
					price: 1312,
					availableCount: 9,
					productCategory: laptopsCategory
				}
			]

			const insertedProducts = await this.productsService.insertManyProducts(products);

			console.log({ insertedProducts });

			await this.dbConfigService.addDbConfig({ is_seeded: true })
		}
	}
}
