import { createAsyncThunk, createSlice } from "@reduxjs/toolkit";
import { IAuthDto } from "../../interfaces/dtos/auth";
import { IAuthResponse } from "../../interfaces/responses/auth";
import axiosInstance from "../../utils/api";
import { ACCESS_TOKEN_LOCAL_STORAGE_KEY } from "../../utils/constants";
import { ActionPayloadType, AxiosResponseDataType } from "../../utils/types";

export interface UserState {
	isAuthenticated: boolean;
	profile: {
		id?: string;
		username?: string;
	}
}

const initialState = {
	isAuthenticated: true,
	profile: {}
} as UserState;

export const loginAsyncAction = createAsyncThunk<IAuthResponse, IAuthDto>('user/login', async (userData, { rejectWithValue }) => {
	const { username, password } = userData;
	try {
		const authRes = await axiosInstance.post('auth/login', { username, password });

		const data: AxiosResponseDataType<IAuthResponse> = authRes.data;

		return data.data;
	} catch (err) {
		return rejectWithValue(err)
	}
})

export const registerAsyncAction = createAsyncThunk<IAuthResponse, IAuthDto>('user/register', async (userData, { rejectWithValue }) => {
	const { username, password } = userData;
	try {
		const authRes = await axiosInstance.post('auth/register', { username, password });

		const data: AxiosResponseDataType<IAuthResponse> = authRes.data;

		return data.data;
	} catch (err) {
		return rejectWithValue(err)
	}
})

export const refreshTokenAsyncAction = createAsyncThunk<IAuthResponse, void>('user/refreshToken', async (val, { rejectWithValue }) => {
	try {
		const authRes = await axiosInstance.post('auth/refresh-token');

		const data: AxiosResponseDataType<IAuthResponse> = authRes.data;

		return data.data;
	} catch (err) {
		return rejectWithValue(err)
	}
})

export const userSlice = createSlice({
	name: 'user',
	initialState,
	reducers: {
		signoutAction: (state, action: ActionPayloadType<void>) => {
			localStorage.removeItem(ACCESS_TOKEN_LOCAL_STORAGE_KEY)

			return {
				...state,
				isAuthenticated: false,
				profile: {}
			};
		},
	},
	extraReducers: {
		[loginAsyncAction.fulfilled.type]: (state, action: ActionPayloadType<IAuthResponse>) => {
			const { id, username, jwt_token } = action.payload;

			axiosInstance.defaults.headers.common["authorization"] = "Bearer " + jwt_token;
			localStorage.setItem(ACCESS_TOKEN_LOCAL_STORAGE_KEY, jwt_token);

			return {
				...state,
				isAuthenticated: true,
				profile: {
					...state.profile,
					id,
					username,
				}
			};
		},

		[registerAsyncAction.fulfilled.type]: (state, action: ActionPayloadType<IAuthResponse>) => {
			const { id, username, jwt_token } = action.payload;

			axiosInstance.defaults.headers.common["authorization"] = "Bearer " + jwt_token;
			localStorage.setItem(ACCESS_TOKEN_LOCAL_STORAGE_KEY, jwt_token);

			return {
				...state,
				isAuthenticated: true,
				profile: {
					...state.profile,
					id,
					username,
				}
			};
		},

		[refreshTokenAsyncAction.fulfilled.type]: (state, action: ActionPayloadType<IAuthResponse>) => {
			const { id, username, jwt_token } = action.payload;

			axiosInstance.defaults.headers.common["authorization"] = "Bearer " + jwt_token;
			localStorage.setItem(ACCESS_TOKEN_LOCAL_STORAGE_KEY, jwt_token);

			return {
				...state,
				isAuthenticated: true,
				profile: {
					...state.profile,
					id,
					username,
				}
			};
		}
	}
})

export const { signoutAction } = userSlice.actions

export default userSlice.reducer