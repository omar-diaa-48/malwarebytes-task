import React, { useEffect } from 'react';
import { useAppDispatch } from '../../store/hooks';
import { adjustProductAction } from '../../store/slices/products';
import { openModalAction } from '../../store/slices/app';
import socketConnection from '../../socket';
import { addItemToCart, removeItemFromCart } from '../../store/slices/cart';

interface SocketProps { }

// Component to handle live stream from the backend
const Socket: React.FC<SocketProps> = () => {
	const dispatch = useAppDispatch();

	useEffect(() => {
		// Listen to 'product-item-change' from server event
		socketConnection.on('product-item-change', ({ productItem, action }) => {
			dispatch(adjustProductAction({ productItem }))

			switch (action as "increased" | "decreased") {
				case "increased":
					dispatch(addItemToCart({ item: productItem }))
					break;
				case "decreased":
					dispatch(removeItemFromCart({ item: productItem }))
					break;
				default:
					break;
			}
		})

		socketConnection.on('notify-product-item-change', ({ productItem, action }) => {
			dispatch(openModalAction({ current: 'message-modal', args: { header: 'Someone changed the data:', content: `${productItem.title} ${action} by 1` } }))
		})

		// Close socket connection on cleanup
		return () => {
			socketConnection.close();
		}
	}, [])

	return <div id='socket-container' />
}

export default Socket