import { OnGatewayConnection, OnGatewayDisconnect, OnGatewayInit, SubscribeMessage, WebSocketGateway, WebSocketServer } from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { SocketService } from './modules/socket/socket.service';
import { ProductsService } from './modules/products/products.service';
import { PRODUCT_ITEM_CHANGE_SOCKET_BROADCAST } from './utils/constants';


@WebSocketGateway({
	cors: {
		origin: process.env.FRONTEND_URL,
	},
})

export class AppGateway implements OnGatewayInit, OnGatewayConnection, OnGatewayDisconnect {

	constructor(
		private socketService: SocketService,
		private productsService: ProductsService
	) { }

	@WebSocketServer() public server: Server;

	afterInit(server: Server) {
		this.socketService.socket = server;
	}

	handleDisconnect(client: Socket) {
		client.removeAllListeners();
	}

	async handleConnection(client: Socket, ...args: any[]) {
		client.join(PRODUCT_ITEM_CHANGE_SOCKET_BROADCAST)
	}

	@SubscribeMessage('increment-product-item')
	async incrementProduct(client: Socket, payload: { productId: string }): Promise<void> {
		const { valid, productItem } = await this.productsService.incrementProduct(payload.productId);

		if (valid) {
			client.broadcast.to(PRODUCT_ITEM_CHANGE_SOCKET_BROADCAST).emit('product-item-change', { productItem, action: 'increased' })
		}
	}

	@SubscribeMessage('decrement-product-item')
	async decrementProduct(client: Socket, payload: { productId: string }): Promise<void> {
		const { valid, productItem } = await this.productsService.decrementProduct(payload.productId);

		if (valid) {
			client.broadcast.to(PRODUCT_ITEM_CHANGE_SOCKET_BROADCAST).emit('product-item-change', { productItem, action: 'decreased' })
		}
	}
}