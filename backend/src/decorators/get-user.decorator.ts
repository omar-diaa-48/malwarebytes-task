import { createParamDecorator, ExecutionContext, UnauthorizedException } from "@nestjs/common";
import { Request } from "express";
import * as jwt from "jsonwebtoken";
import { JwtPayload } from "src/modules/auth/dto/jwt-payload";
import { ERROR_MESSAGES } from "src/utils/message";

export const GetUser = createParamDecorator(
	(data: unknown, ctx: ExecutionContext) => {
		const request: Request = ctx.switchToHttp().getRequest();
		const jwttoken = request.headers["authorization"];

		if (!jwttoken) {
			throw new UnauthorizedException(ERROR_MESSAGES.AUTH.NOT_AUTHORIZED)
		}

		const accessToken = jwttoken.split(' ')[1]

		const payload: JwtPayload = jwt.decode(accessToken) as JwtPayload;

		return payload;
	},
);