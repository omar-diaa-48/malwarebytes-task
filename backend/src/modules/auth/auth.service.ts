import { BadRequestException, Injectable, NotFoundException } from '@nestjs/common';
import { UserService } from '../user/user.service';
import { AuthDto } from './auth.dto';
import { JwtPayload } from './dto/jwt-payload';
import * as jwt from "jsonwebtoken";
import * as bcrypt from "bcrypt";
import { ConfigService } from '@nestjs/config';

@Injectable()
export class AuthService {
	constructor(
		private configService: ConfigService,
		private userService: UserService,
	) { }

	async login(dto: AuthDto): Promise<JwtPayload> {
		const { username, password } = dto;

		const user = await this.userService.findUserByUserName(username);

		if (!user) {
			throw new NotFoundException("User with this name not found")
		}

		const isValidCredentials = bcrypt.compareSync(password, user.password)

		if (!isValidCredentials) {
			throw new NotFoundException("User credentials is incorrect, please try again")
		}

		const payload: JwtPayload = {
			id: user._id,
			username: user.username,
		}

		const jwt_token = jwt.sign(payload, this.configService.get<string>("TOKEN_SECRET"));

		payload.jwt_token = jwt_token;

		return payload;
	}

	async register(dto: AuthDto): Promise<JwtPayload> {
		const { username, password } = dto;

		let user = await this.userService.findUserByUserName(username);

		if (!user) {
			throw new BadRequestException("User with this name already exists, should you signin in?")
		}

		user = await this.userService.createUser({ username, password })

		const payload: JwtPayload = {
			id: user._id,
			username: user.username,
		}

		const jwt_token = jwt.sign(payload, this.configService.get<string>("TOKEN_SECRET"));

		payload.jwt_token = jwt_token;

		return payload;
	}
}